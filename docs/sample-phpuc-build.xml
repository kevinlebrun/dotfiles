<?xml version="1.0" encoding="UTF-8"?>
<project name="site.cloud_priv.sfr.com" basedir="." default="build">
    <property name="builddir" value="${project.basedir}/build" />
    <property name="srcdir" value="${project.basedir}/src" override="true" />

    <fileset dir="${srcdir}" id="phpsrc">
        <include name="**/*.php" />
        <include name="**/*.phtml" />
    </fileset>

    <target name="clean">
        <delete dir="${builddir}" />
    </target>

    <target name="init">
        <delete dir="${srcdir}" />
        <exec command="hg clone /var/www/fel.sfr.com ${srcdir}" />
        <exec command="ln -s /usr/share/php5/ZendFramework-1.11.6/library/Zend/ ${srcdir}/library/Zend" />
        <exec command="ln -s /usr/share/php5/phly/Phly_PubSub/library/Phly/ ${srcdir}/library/Phly" />
        <phingcall target="prepare" />
    </target>

    <target name="prepare" depends="clean">
        <mkdir dir="${builddir}/docs" />
        <mkdir dir="${builddir}/logs" />
        <mkdir dir="${builddir}/coverage" />
        <mkdir dir="${builddir}/graph" />
    </target>

    <target name="pull">
        <exec command="hg pull" dir="${srcdir}" />
        <exec command="hg update" dir="${srcdir}" />
    </target>

    <target name="build" depends="prepare,pull">
        <phingcall target="phplint" />
        <phingcall target="phpunit" />
        <phingcall target="phpdoc" />
        <phingcall target="phpcpd" />
        <phingcall target="pdepend" />
        <phingcall target="phppmd" />
        <phingcall target="phpcodesniffer" />
        <phingcall target="phpcb" />
        <phingcall target="phploc" />
    </target>

    <target name="phpunit" description="Run unit tests and coverage analysis">
        <exec command="phpunit
            --coverage-html ${builddir}/coverage/
            --testdox-html ${builddir}/logs/textdox.html
            --coverage-clover ${builddir}/build/logs/phpunit.coverage.xml
            --log-junit ${builddir}/logs/phpunit.xml -c ${srcdir}/tests/phpunit.xml" />
    </target>

    <target name="phpdoc" description="Generate documentation">
        <phpdoc title="FEL API Documentation" destdir="${builddir}/docs" sourcecode="true"
            templatebase="/usr/share/php/data/phpUnderControl/data/phpdoc"
            parseprivate="true" output="HTML:Phpuc:phpuc">
            <fileset dir="${srcdir}">
                <include name="**/*.php" />
            </fileset>
        </phpdoc>
    </target>

    <target name="phpcpd" description="Copy/Paste Detector">
        <phpcpd minTokens="8" minLines="5">
            <fileset refid="phpsrc" />
            <formatter type="pmd" outfile="${builddir}/logs/pmd-cpd.xml" />
        </phpcpd>
    </target>

    <target name="pdepend" description="Generate JDepend report">
        <phpdepend>
            <fileset refid="phpsrc" />
            <logger type="jdepend-xml" outfile="${builddir}/logs/pdepend.xml" />
            <logger type="jdepend-chart" outfile="${builddir}/graph/10-dependencies.svg" />
            <logger type="overview-pyramid" outfile="${builddir}/graph/11-software-metrics-pyramid.svg" />
            <analyzer type="coderank-mode" value="inheritance" />
            <analyzer type="coderank-mode" value="property" />
            <analyzer type="coderank-mode" value="method" />
        </phpdepend>
    </target>

    <target name="phppmd" description="Generate PHP Mess Detector report">
        <phpmd rulesets="codesize,naming,unusedcode,design">
            <fileset refid="phpsrc" />
            <formatter type="xml" outfile="${builddir}/logs/pmd.xml" />
        </phpmd>
    </target>

    <target name="phplint" description="Check PHP syntax">
        <phplint deprecatedAsError="true">
            <fileset refid="phpsrc" />
        </phplint>
    </target>

    <target name="phpcodesniffer" description="Detect violation of coding standards">
        <!--<phpcodesniffer standard="Zend" showSniffs="true" showWarnings="true">
            <fileset refid="phpsrc" />
            <formatter type="default" usefile="false" />
            <formatter type="checkstyle" outfile="${builddir}/logs/checkstyle.xml" />
        </phpcodesniffer> bug task on command line arguments (see pear bug tracker for resolution)-->
        <exec command="phpcs
            --standard=Zend --report-checkstyle=${builddir}/logs/checkstyle.xml
            --extensions=php,phtml --ignore=*/library/Zend/*,*/build/*
            --encoding=utf-8 ${srcdir}" escape="false" />
    </target>

    <target name="phpcb" description="Generate code browser">
        <exec command="phpcb
            --log ${builddir}/logs
            --source ${srcdir} -e **/build/** -e **/data/** -e **/logs/**
            --output ${builddir}/browser" />
    </target>

    <target name="phploc" description="Generate LOC report">
        <exec command="phploc --count-tests --log-xml ${builddir}/logs/loc.xml ${srcdir}" />
    </target>
</project>
