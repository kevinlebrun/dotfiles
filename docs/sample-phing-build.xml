<?xml version="1.0" encoding="UTF-8"?>
<project name="site.cloud_priv.sfr.com" basedir="." default="build">
    <property file="./build.properties" />
    <property name="builddir" value="${project.basedir}${dir.build}" />
    <property name="srcdir" value="${project.basedir}${dir.src}" />

    <fileset dir="${srcdir}" id="phpsrc">
        <include name="**/*.php" />
        <include name="**/*.phtml" />
        <exclude name="**/Bisna/**" />
    </fileset>

    <target name="clean">
        <delete dir="${builddir}" />
    </target>

    <target name="init-ci">
        <delete dir="${srcdir}" />
        <exec command="hg clone ${repository} ${srcdir}" />
        <phingcall target="install" />
    </target>

    <target name="install">
        <available file="/usr/share/php5/phly/Phly_PubSub/library/Phly/" type="dir" property="library.phly" />
        <fail unless="library.phly" message="Librairie Phly manquante !" />
        <exec command="ln -s /usr/share/php5/phly/Phly_PubSub/library/Phly/ ${srcdir}/library/Phly" />

        <available file="/usr/share/php5/ZendFramework-latest/library/Zend/" type="dir" property="library.zend" />
        <fail unless="library.zend" message="Framework Zend manquant !" />
        <exec command="ln -s /usr/share/php5/ZendFramework-latest/library/Zend/ ${srcdir}/library/Zend" />

        <available file="/usr/share/php/Doctrine/" type="dir" property="library.doctrine" />
        <fail unless="library.doctrine" message="ORM Doctrine manquant !" />
        <exec command="ln -s /usr/share/php/Doctrine/ ${srcdir}/library/Doctrine" />

        <exec command="sudo chgrp www-data -R ${srcdir}/logs" />
        <exec command="sudo chmod g+w -R ${srcdir}/logs" />
    </target>

    <target name="prepare" depends="clean">
        <mkdir dir="${builddir}/docs" />
        <mkdir dir="${builddir}/logs" />
        <mkdir dir="${builddir}/coverage" />
        <mkdir dir="${builddir}/graph" />
    </target>

    <target name="pull">
        <exec command="hg pull" dir="${srcdir}" />
        <exec command="hg update" dir="${srcdir}" />
    </target>

    <target name="build-ci">
        <phingcall target="pull" />
        <phingcall target="build" />
    </target>

    <target name="build" depends="prepare">
        <phingcall target="phplint" />
        <phingcall target="phpunit" />
        <!--<phingcall target="phpdoc" />-->
        <phingcall target="docblox" />
        <phingcall target="phpcpd" />
        <phingcall target="pdepend" />
        <phingcall target="phppmd" />
        <phingcall target="phpcodesniffer" />
        <phingcall target="phpcb" />
        <phingcall target="phploc" />
    </target>

    <target name="phpunit" description="Run unit tests and coverage analysis">
        <exec command="phpunit
            --coverage-html ${builddir}/coverage/
            --testdox-html ${builddir}/logs/textdox.html
            --coverage-clover ${builddir}/build/logs/phpunit.coverage.xml
            --log-junit ${builddir}/logs/phpunit.xml -c ${srcdir}/tests/phpunit.xml" />
    </target>

    <target name="phpdoc" description="Generate documentation">
        <!-- set meta utf-8 in the header.tpl file -->
        <phpdoc title="FEL API Documentation" destdir="${builddir}/docs" sourcecode="true"
            templatebase="/usr/share/php/data/phpUnderControl/data/phpdoc"
            parseprivate="true" output="HTML:Phpuc:phpuc">
            <fileset dir="${srcdir}">
                <include name="**/*.php" />
                <exclude name="**/Bisna/**" />
            </fileset>
        </phpdoc>
    </target>

    <target name="docblox" description="Generate documentation using docblox">
        <!-- set meta utf-8 in the header.tpl file -->
        <exec command="docblox run -d ${srcdir} -t ${builddir}/docs 
            -i tests/*,library/Bisna/*,build/*,logs/* --template zend"/>
    </target>

    <target name="phpcpd" description="Copy/Paste Detector">
        <phpcpd minTokens="50" minLines="5">
            <fileset refid="phpsrc" />
            <formatter type="pmd" outfile="${builddir}/logs/pmd-cpd.xml" />
        </phpcpd>
    </target>

    <target name="pdepend" description="Generate JDepend report">
        <phpdepend>
            <fileset refid="phpsrc" />
            <logger type="jdepend-xml" outfile="${builddir}/logs/pdepend.xml" />
            <logger type="jdepend-chart" outfile="${builddir}/graph/10-dependencies.svg" />
            <logger type="overview-pyramid" outfile="${builddir}/graph/11-software-metrics-pyramid.svg" />
            <analyzer type="coderank-mode" value="inheritance" />
            <analyzer type="coderank-mode" value="property" />
            <analyzer type="coderank-mode" value="method" />
        </phpdepend>
    </target>

    <target name="phppmd" description="Generate PHP Mess Detector report">
        <exec command="phpmd ${srcdir} xml ${srcdir}/tests/phppmd.xml
            --reportfile ${builddir}/logs/pmd.xml
            --extensions php,phtml,inc
            --ignore **/Bisna/**" escape="false" />
    </target>

    <target name="phplint" description="Check PHP syntax">
        <phplint deprecatedAsError="true">
            <fileset refid="phpsrc" />
        </phplint>
    </target>

    <target name="phpcodesniffer" description="Detect violation of coding standards">
        <exec command="phpcs
            --standard=${srcdir}/tests/phpcs.xml --report-checkstyle=${builddir}/logs/checkstyle.xml
            --extensions=php,phtml --encoding=utf-8 ${srcdir}" escape="false" />
    </target>

    <target name="phpcb" description="Generate code browser">
        <exec command="phpcb
            --log ${builddir}/logs
            --source ${srcdir} -e **/build/** -e **/data/** -e **/logs/**
            --output ${builddir}/browser" />
    </target>

    <target name="phploc" description="Generate LOC report">
        <exec command="phploc --count-tests --log-xml ${builddir}/logs/loc.xml ${srcdir}" />
    </target>
</project>
