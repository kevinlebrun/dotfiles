#!/usr/bin/env bash

if [ $# -ne 2 ]
then
    echo "Please speciffy two args - .ebuild file and unpack, compile, or all"
    exit 1
fi

# looking for $MAKEOPTS
source /etc/ebuild.conf

if [ -z "$DISTDIR" ]
then
    # set DISTDIR to /usr/src/distfiles if not already set
    DISTDIR=/usr/src/distfiles
fi
export DISTDIR

ebuild_unpack() {
    # make sure we're in the right directory
    cd ${ORIGDIR}

    if [ -d ${WORKDIR} ]
    then
        rm -rf ${WORKDIR}
    fi

    mkdir ${WORKDIR}
    cd ${WORKDIR}
    if [ ! -e ${DISTDIR}/${A} ]
    then
        echo "${DISTDIR}/${A} does not exist. Please download first."
        exit 1
    fi
    tar xzf ${DISTDIR}/${A}
    echo "Unpacked ${DISTDIR}/${A}."
    # source is now correctly unpacked
}

user_compile() {
    # we're in ${SRCDIR}
    if [ -e configure ]
    then
        ./configure --prefix=/usr
    fi
    # run make
    make $MAKEOPTS MAKE="make $MAKEOPTS"
}

ebuild_compile() {
    # make sure we're in the right directory
    if [ ! -d "${SRCDIR}" ]
    then
        echo "${SRCDIR} does not exist -- please unpack first."
        exit 1
    fi
    cd ${SRCDIR}
    user_compile
}

export ORIGDIR=`pwd`
export WORKDIR=${ORIGDIR}/work

if [ -e "$1" ]
then
    source $1
else
    echo "Ebuild file $1 not found."
    exit 1
fi

export SRCDIR=${WORKDIR}/${P}

case "${2}" in
    unpack)
        ebuild_unpack
        ;;
    compile)
        ebuild_compile
        ;;
    all)
        ebuild_unpack
        ebuild_compile
        ;;
    *)
        echo "Please specify unpack, compile, or all as the second arg"
        exit 1
        ;;
esac
